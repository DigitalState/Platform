---
- block:
    - name: Log into docker
      docker_login:
        email: '{{ _credential.split(":")[0] }}'
        username: '{{ _credential.split(":")[1] }}'
        password: '{{ _credential.split(":")[2] }}'
      changed_when: false
    - name: Up tenants container
      docker_service:
        project_src: /srv/tenants
        files:
          - docker-compose.yml
          - 'docker-compose.{{ _env }}.yml'
        state: present
      environment:
        COMPOSE_PROJECT_NAME: '{{ _compose_project_name }}'
        NETWORK: '{{ _network }}'
        PROXY_HOST: '{{ _proxy_host }}'
        NGINX_VIRTUAL_HOST: '{{ _nginx_virtual_host }}'
        ADMINER_VIRTUAL_HOST: '{{ _adminer_virtual_host }}'
        REBROW_VIRTUAL_HOST: '{{ _rebrow_virtual_host }}'
        DISCOVERY_HOST: '{{ _discovery_host }}'
        DISCOVERY_CREDENTIAL: '{{ _discovery_credential }}'
        DIRECTORY: '{{ _directory }}'
        DATABASE_HOST: '{{ _database_host }}'
        DATABASE_PORT: '{{ _database_port }}'
        DATABASE_NAME: '{{ _database_name }}'
        DATABASE_USERNAME: '{{ _database_username }}'
        DATABASE_PASSWORD: '{{ _database_password }}'
    - name: Waiting for tenants container to finalize installation
      shell:
        cmd: docker-compose exec -T php pidof php-fpm | cat
        chdir: /srv/tenants
      register: _output
      until: _output.stdout is match('^[0-9]+(\s[0-9]+)*$')
      retries: 60
      delay: 10
      changed_when: false
  tags: [tenants]
