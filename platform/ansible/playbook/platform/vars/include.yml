---
- name: Include variables files
  hosts: all
  gather_facts: false
  tasks:
    - name: Include base variables files
      include_vars:
        dir: '/etc/ansible/env/{{ env }}/vars'
    - name: Include app variables files
      include_vars:
        dir: '/etc/ansible/env/{{ env }}/vars/app'
        name: app
  tags: [always]

- name: Configure automatic variables
  hosts: app
  gather_facts: false
  tasks:
    - name: Obtain app container srv mount
      shell: docker inspect --format '{{ '{{' }}range .Mounts{{ '}}' }}{{ '{{' }}if (eq .Destination "/srv"){{ '}}' }}{{ '{{' }}.Source{{ '}}' }}{{ '{{' }}end{{ '}}' }}{{ '{{' }}end{{ '}}' }}' app
      register: app_container_mount_srv
      when:
        - directory is none
        - hostvars['app']['ansible_host'] == 'app'
    - name: Define directory variable
      set_fact:
        directory: '{{ app_container_mount_srv.stdout }}'
      when:
        - directory is none
        - hostvars['app']['ansible_host'] == 'app'
  tags: [always]
