---
- import_playbook: /etc/ansible/playbook/platform/vars/include.yml

- name: Compile container/up task list
  hosts: platform
  become: true
  tasks:
    - name: Compile files
      compile:
        app: '{{ app }}'
        directory: /etc/ansible/task/app/*
        task: container/up
      register: files
  tags: [always]

- name: Up containers
  hosts: app
  become: true
  tasks:
    - name: Obtain app container srv mount
      shell: docker inspect --format '{{ '{{' }}range .Mounts{{ '}}' }}{{ '{{' }}if (eq .Destination "/srv"){{ '}}' }}{{ '{{' }}.Source{{ '}}' }}{{ '{{' }}end{{ '}}' }}{{ '{{' }}end{{ '}}' }}' app
      register: app_container_mount_srv
      when:
        - directory is none
        - hostvars['app']['ansible_host'] == 'app'
      tags: [always]
    - name: Define directory variable
      set_fact:
        directory: '{{ app_container_mount_srv.stdout }}'
      when:
        - directory is none
        - hostvars['app']['ansible_host'] == 'app'
      tags: [always]
    - name: Include compiled task list
      include_tasks: '{{ item }}'
      with_items: '{{ hostvars["platform"]["files"]["tasks"] }}'
      tags: [always]
